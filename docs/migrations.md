# Міграції за конфігурацією Amadin

Цей документ описує, як генерується Prisma-схема та міграції на основі `examples/demo-config.json`.

## Генерація артефактів

```
npm run generate
```

- `generated/app.prisma` – оновлена Prisma-схема для застосунку.
- `generated/ui-manifest.json` – маніфест користувацького інтерфейсу.
- `generated/state.json` – знімок сутностей (`code`, `kind`, поля), використовується для порівняння у наступних запусках.
- `generated/migration-report.json` – diff між попереднім і поточним знімком (додані, змінені, видалені сутності та поля).

## Запуск міграцій

```
npm run migrate
```

Команда виконує:

1. Повторну генерацію артефактів (щоб `state.json` та diff були актуальними).
2. Формування плану міграції відповідно до `kind` сутності:
   - **catalog/document/register** – генерується SQL для створення/зміни/видалення таблиць та колонок з полями `id`, `createdAt`, `updatedAt`.
3. Створення нової міграції у `generated/migrations/<timestamp>_<slug>/` з файлами:
   - `migration.sql`
   - `README.md` із коротким звітом.
4. Виконання `npx prisma migrate deploy --schema=generated/app.prisma` для застосування міграцій до бази даних.

## Робочий процес

1. Оновіть `examples/demo-config.json` (додайте/змініть сутності, поля, kind).
2. Запустіть `npm run generate`, щоб побачити diff у `generated/migration-report.json`.
3. Переконайтесь, що зміни коректні.
4. Запустіть `npm run migrate`, щоб сформувати та застосувати міграції.
5. Додайте файли міграцій, оновлену Prisma-схему та state/report у git.

## Поради

- Міграції генеруються лише для сутностей, описаних у конфігурації. Якщо потрібні звʼязки через foreign key, доведеться доповнити генератор.
- Видалення сутності призведе до `DROP TABLE` – переконайтесь, що дані можна видалити або зробіть резервну копію.
- Поле, тип або `required` змінюються через `ALTER TABLE`. Для складніших сценаріїв (наприклад, перейменування поля) потрібно відредагувати SQL вручну перед застосуванням.
